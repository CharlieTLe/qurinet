<!doctype html>
<meta charset="utf-8">

<script src="http://www.d3plus.org/js/d3.js"></script>
<script src="http://www.d3plus.org/js/d3plus.js"></script>

<div id="viz"></div>

<script>

  var data; 
  var network = d3plus.viz();
  var node_data = [];
  var connections = []; 


  var loadData = function(url) {
    d3.json(url, function(error, json) {
        if (error) return console.warn(error);
        node_data = json.nodes;
        console.log(connections);

        var isHardUpdate = false;
        console.log(json.connections);
        if (connections.length > 0 && connections.length == json.connections.length) {          
          for (var compare = 0; compare < connections.length; compare++) {
            if (connections[compare].source.name != json.connections[compare].source && 
                connections[compare].target.name != json.connections[compare].target) {
                isHardUpdate = true;
                break;
            }
          }
        } else {
          isHardUpdate = true;
        }
        
        connections = json.connections;
        console.log(isHardUpdate);
        if (!isHardUpdate) {
            softUpdate();
        }
        else {
            console.log("Hard Update");
            hardUpdate();
        }
    });  
  }


  init = function (url) {
    d3.json(url, function(error, json) {
        if (error) return console.warn(error);
        node_data = json.nodes;
        connections = json.connections;
        network 
          .container("#viz")
          .type("network")
          .data(node_data)
          .edges(connections)
          .edges({
            "size": "bandwidth",
            "label": "bandwidth",
            "color": function(e) {
                return e.linkColor;
            }            
          })    
          .size("willingness")
          .id("name")
          .color("state")
          .tooltip("MPRSelector")
          .draw()
    }); 
    
    setInterval(function() { loadData(url) }, 5000);
  }
  
  hardUpdate = function()
  {
    network = d3plus.viz();
    network 
          .container("#viz")
          .type("network")
          .data(node_data)
          .edges(connections)
          .edges({
            "size": "bandwidth",
            "label": "bandwidth",
            "color": function(e) {
                return e.linkColor;
            }
          })     
          .size("willingness")
          .id("name")
          .color("state")
          .tooltip("MPRSelector")
          .draw();
  }
  
  softUpdate = function()
  {
    network
        .data(node_data)
        .edges(connections)
        .edges({
          "size": "bandwidth",
          "label": "bandwidth",
          "color": function(e) {
                return e.linkColor;
          }
        })  
        .color("state")
        .tooltip("MPRSelector")
        .draw();
  }
  

  init("generatedolsrtop.json");
</script>